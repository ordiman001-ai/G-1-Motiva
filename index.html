<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный Центр Развития</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        :root {
            --primary-color: #4f46e5; /* Indigo-600 */
            --secondary-color: #8b5cf6; /* Violet-500 */
            --bg-color: #f8f8fb;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            transition: all 0.3s ease;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        .tab-button {
            transition: all 0.2s;
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e0e0f0;
        }
        .task-card, .challenge-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .library-content {
            line-height: 1.8;
            text-align: justify;
        }
        /* Стили для чата */
        .message-bubble {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.4;
        }
        .user-message {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 2px;
        }
        .ai-message {
            background-color: #e0e7ff; /* Indigo-100 */
            color: #374151; /* Gray-700 */
            border-bottom-left-radius: 2px;
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex items-start justify-center">

    <!-- Main Application Container -->
    <div id="app-container" class="w-full max-w-7xl bg-white rounded-3xl shadow-2xl p-6 sm:p-10 transition-all duration-500 min-h-[85vh] flex flex-col">

        <!-- Header with User ID (for multi-user app requirement) -->
        <header class="mb-4 flex justify-between items-center pb-2 border-b">
            <h1 class="text-3xl font-extrabold text-indigo-700">Личный Тренер</h1>
            <p id="user-id-display" class="text-sm text-gray-500 flex items-center">
                <i class="fas fa-user-circle mr-1"></i> ID: Загрузка...
            </p>
        </header>

        <!-- Top Navigation (Tabs) -->
        <nav id="app-navigation" class="border-b mb-6 pb-4 overflow-x-auto whitespace-nowrap">
            <!-- Tabs will be rendered here -->
        </nav>

        <!-- Dynamic Content Area -->
        <div id="content-area" class="flex-grow custom-scrollbar overflow-y-auto">
            <!-- Content will be rendered here dynamically -->
        </div>

        <!-- Loading Spinner for AI/Data -->
        <div id="loading-spinner" class="hidden absolute inset-0 bg-white bg-opacity-70 flex items-center justify-center rounded-3xl z-40">
            <div class="flex flex-col items-center">
                <i class="fas fa-sync-alt fa-spin text-4xl text-indigo-500 mb-3"></i>
                <p class="text-indigo-700 font-semibold">Загрузка данных...</p>
            </div>
        </div>

    </div>

    <!-- Modal for User Feedback (non-alert) -->
    <div id="app-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-md w-full">
            <h4 id="modal-title" class="text-2xl font-bold text-indigo-600 mb-4"></h4>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <button onclick="document.getElementById('app-modal').classList.add('hidden')" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors">
                Понятно
            </button>
        </div>
    </div>

    <!-- Modal for "Give Up" Explanation (New) -->
    <div id="give-up-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full">
            <h4 class="text-2xl font-bold text-red-600 mb-4 flex items-center">
                <i class="fas fa-hand-paper mr-2"></i> Почему вы сдаетесь?
            </h4>
            <p class="text-gray-700 mb-6">Ваш тренер хочет вам помочь! Пожалуйста, объясните, с какой проблемой вы столкнулись при выполнении задания.</p>
            <form id="give-up-form">
                <textarea id="give-up-explanation" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-red-500 focus:border-red-500 mb-6" placeholder="Например: 'У меня не хватило времени из-за работы', 'Задание оказалось слишком сложным' или 'Я забыл о нем.'"></textarea>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="document.getElementById('give-up-modal').classList.add('hidden'); window.appState.currentGiveUpTask = null;" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-xl hover:bg-gray-300 transition-colors">
                        Отмена
                    </button>
                    <button type="submit" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-xl hover:bg-red-700 transition-colors">
                        Сдаться и получить помощь
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase Imports and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Setup (Mandatory Globals)
        setLogLevel('Debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'development-self-coach';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Utility function for showing modal messages
        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerHTML = message;
            document.getElementById('app-modal').classList.remove('hidden');
            document.getElementById('app-modal').classList.add('flex');
        }

        // --- Core Data Structures ---

        const SPHERES = {
            health: 'Здоровье',
            sport: 'Спорт',
            communication: 'Общение',
            learning: 'Обучение и Развитие'
        };

        const TRAINERS = {
            aurora: { 
                key: 'aurora', 
                name: 'Аврора', 
                role: 'Подруга-поддержка', 
                icon: 'fa-regular fa-face-smile-wink', 
                color: 'text-pink-500', 
                bg: 'bg-pink-100',
                systemInstruction: "Вы Аврора, дружелюбный и поддерживающий мотивационный тренер. Ваш тон всегда теплый, ободряющий и мягкий. Сосредоточьтесь на положительном подкреплении, самосострадании и пошаговых, несложных действиях. Используйте смайлики и неформальную речь. Ваша цель — сделать так, чтобы пользователь почувствовал себя способным и любимым."
            },
            johnny: { 
                key: 'johnny', 
                name: 'Джонни', 
                role: 'Строгий тренер', 
                icon: 'fa-solid fa-graduation-cap', 
                color: 'text-red-600', 
                bg: 'bg-red-100',
                systemInstruction: "Вы Джонни, строгий, но справедливый тренер, ориентированный на результат. Ваш тон прямой, аналитический и требовательный. Сосредоточьтесь на дисциплине, измерении прогресса, постановке SMART-целей и ответственности. Используйте профессиональный, четкий язык. Ваша цель — подтолкнуть пользователя к максимальной эффективности и избежать прокрастинации."
            },
            silas: { 
                key: 'silas', 
                name: 'Сайлас', 
                role: 'Мудрец-философ', 
                icon: 'fa-solid fa-feather-pointed', 
                color: 'text-indigo-600', 
                bg: 'bg-indigo-100',
                systemInstruction: "Вы Сайлас, мудрый и философский наставник. Ваш тон спокойный, глубокий и интроспективный. Ваши ответы должны включать размышления о долгосрочном смысле, природе привычек и мышления. Задавайте наводящие вопросы о внутренней мотивации и избегайте поверхностных советов. Используйте метафоры и высокий слог. Ваша цель — помочь пользователю понять 'почему' он что-то делает."
            },
        };

        const TABS = [
            { id: 'home', name: 'Главная', icon: 'fas fa-home' },
            { id: 'tasks', name: 'Задачи', icon: 'fas fa-tasks' },
            { id: 'challenges', name: 'Челленджи', icon: 'fas fa-running' },
            { id: 'healthy_sleep', name: 'Здоровый сон', icon: 'fas fa-bed' },
            { id: 'library', name: 'Библиотека', icon: 'fas fa-book-reader' },
            { id: 'chat', name: 'Тренер', icon: 'fas fa-comments' },
        ];
        
        const MOTIVATIONAL_PHRASES = [
            "Каждый день – это чистый лист. Напиши свою лучшую историю!",
            "Успех — это сумма маленьких усилий, повторяющихся изо дня в день.",
            "Начинай с малого, но начинай сейчас. Идеального момента не существует.",
            "Ты сильнее, чем думаешь. Докажи это себе сегодня!",
            "Твоя энергия определяет твое будущее. Инвестируй в нее wisely.",
            "Философия: не спрашивай, что мир может сделать для тебя, а спроси, что ты можешь сделать, чтобы изменить свой мир.",
            "Дисциплина — это мост между целями и их достижением.",
            "Верь в себя. Ты уже прошел 100% самых трудных дней в своей жизни.",
        ];

        // Placeholder for initial state, will be overwritten by Firestore
        window.appState = {
            activeTab: 'home',
            userData: {
                tasks: [],
                challenges: [],
                sleepPlan: [],
                quizScore: 0,
                selectedTrainer: TRAINERS.aurora.key,
                chatHistory: [],
                quizAnswers: {}
            },
            currentGiveUpTask: null // Stores the ID of the task being given up
        };

        // --- Data Definitions (Completed) ---

        const QUIZ_QUESTIONS = [
            { sphere: 'health', text: 'Как часто вы чувствуете прилив сил после пробуждения?' },
            { sphere: 'sport', text: 'Как бы вы оценили свою физическую активность (сколько часов в неделю)?' },
            { sphere: 'communication', text: 'Насколько легко вы начинаете разговор с незнакомым человеком?' },
            { sphere: 'learning', text: 'Как часто вы выделяете время для целенаправленного изучения нового?' },
        ];

        const CHALLENGES_DATA = [
            { id: 'C1', name: 'Цифровой Детокс', duration: 3, focus: 'Осознанность',
                steps: [
                    'Уберите телефон из спальни (заряжайте в другой комнате).',
                    'Отключите все уведомления (кроме звонков) на весь день.',
                    'Один час без телефона после пробуждения и за час до сна.'
                ]},
            { id: 'C2', name: '7 Дней Без Сахара', duration: 7, focus: 'Питание',
                steps: [
                    'Полностью исключите явный сахар и кондитерские изделия.',
                    'Исключите сладкие напитки (соки, газировка).',
                    'Если хочется сладкого, используйте фрукты или ягоды.'
                ]},
            { id: 'C3', name: 'Ежедневная Благодарность', duration: 5, focus: 'Мышление',
                steps: [
                    'Утром записывайте 3 вещи, за которые вы благодарны.',
                    'Вечером вспоминайте 1 позитивный момент дня.',
                    'Поделитесь благодарностью с кем-то из близких.'
                ]},
            { id: 'C4', name: 'Водный Баланс', duration: 10, focus: 'Здоровье',
                steps: [
                    'Выпивайте 2.5 литра чистой воды в день.',
                    'Начните день со стакана воды.',
                    'Замените все напитки (чай, кофе) чистой водой после 18:00.'
                ]},
        ];

        const SLEEP_PLAN = [
            { day: 1, title: 'Режим — это сила', task: 'Установите и придерживайтесь одного и того же времени отхода ко сну и пробуждения (+/- 15 минут) на сегодня.', benefit: 'Это помогает настроить ваши циркадные ритмы, делая пробуждение естественным и энергичным.' },
            { day: 2, title: 'Уберите кофеин', task: 'Исключите потребление кофе, крепкого чая и энергетиков после 14:00.', benefit: 'Кофеин остается в организме до 10 часов, мешая глубоким фазам сна. Ранний отказ обеспечит спокойствие.' },
            { day: 3, title: 'Очистка спальни', task: 'Сделайте вашу спальню максимально темной, тихой и прохладной. Оптимальная температура - $18-20^\circ \text{C}$.', benefit: 'Эти условия критически важны для выработки мелатонина (гормона сна) и повышения качества сна.' },
            { day: 4, title: 'Цифровой закат', task: 'Отключите все экраны (телефон, ТВ, планшет) за 60 минут до сна.', benefit: 'Синий свет подавляет мелатонин. Замена экранов на книгу или медитацию ускорит засыпание.' },
            { day: 5, title: 'Ритуал расслабления', task: 'Создайте 15-минутный расслабляющий ритуал: теплая ванна, легкая растяжка или чтение книги.', benefit: 'Мозг нуждается в сигнале о переходе к отдыху. Ритуал снижает уровень кортизола (гормона стресса).' },
            { day: 6, title: 'Дневник сновидений', task: 'Держите блокнот рядом с кроватью и записывайте туда тревожные мысли или идеи перед сном.', benefit: 'Помогает "выгрузить" беспокойства из головы, предотвращая мысленную жвачку, мешающую сну.' },
            { day: 7, title: 'Обед без тяжести', task: 'Избегайте тяжелой, острой или жирной пищи за 3 часа до сна. Разрешен легкий перекус.', benefit: 'Пищеварение требует энергии, которая должна идти на восстановление. Легкий желудок способствует глубокому сну.' },
            { day: 8, title: 'Минимум жидкости', task: 'Сведите к минимуму потребление жидкости за 2 часа до сна, чтобы избежать ночных пробуждений.', benefit: 'Предотвращение походов в туалет ночью сохранит циклы глубокого сна.' },
            { day: 9, title: 'Прогулка днем', task: 'Проведите 30 минут на солнечном свете в первой половине дня.', benefit: 'Яркий свет днем помогает "сбросить" циркадные часы и гарантирует сильное желание спать вечером.' },
            { day: 10, title: 'Уберите часы', task: 'Уберите из поля зрения все часы (аналоговые и цифровые), когда ложитесь спать.', benefit: 'Постоянное отслеживание времени вызывает стресс и бессонницу. Уменьшение тревоги.' },
            { day: 11, title: '15 минут медитации', task: 'Попробуйте 15-минутную медитацию или дыхательное упражнение прямо в постели.', benefit: 'Снижает частоту сердечных сокращений и успокаивает нервную систему перед засыпанием.' },
            { day: 12, title: 'Нет алкоголю', task: 'Полностью откажитесь от алкоголя сегодня. Даже небольшие дозы нарушают качество сна.', benefit: 'Алкоголь нарушает REM-фазу, что приводит к поверхностному и невосстанавливающему сну.' },
            { day: 13, title: 'Закрепление ритуала', task: 'Выполните свой вечерний ритуал (День 5) на 5 минут дольше, чтобы закрепить привычку.', benefit: 'Повторение и небольшое усложнение укрепляет нейронные связи.' },
            { day: 14, title: 'Сонник в голове', task: 'Используйте кровать только для сна и секса. Никакой работы, чтения или просмотра ТВ.', benefit: 'Создает сильную ассоциацию "кровать = сон" в вашем мозгу, улучшая скорость засыпания.' },
            { day: 15, title: 'Работа с шумом', task: 'Используйте "белый шум" (white noise) или беруши, если вас беспокоят внешние звуки.', benefit: 'Маскирует резкие звуки, которые могут вырвать вас из глубокого сна.' },
            { day: 16, title: 'Зарядка утром', task: 'Сделайте короткую физическую зарядку (5-10 минут) сразу после пробуждения.', benefit: 'Помогает организму полностью проснуться и запускает метаболизм.' },
            { day: 17, title: 'Мини-цель на день', task: 'Напишите три главные цели на завтрашний день, чтобы освободить мозг перед сном.', benefit: 'Снижает ментальное пережевывание и тревогу по поводу предстоящих дел.' },
            { day: 18, title: 'Дневной сон', task: 'Если нужен дневной сон, то строго не более 30 минут и до 15:00.', benefit: 'Длинный или поздний дневной сон нарушает ночной режим.' },
            { day: 19, title: 'Ароматерапия', task: 'Используйте лавандовое масло или другой расслабляющий аромат в спальне.', benefit: 'Некоторые запахи могут сигнализировать мозгу о безопасности и расслаблении.' },
            { day: 20, title: 'Теплые носки', task: 'Наденьте теплые носки, чтобы улучшить кровообращение и снизить температуру тела, что способствует сну.', benefit: 'Охлаждение центрального тела — важный сигнал для начала сна.' },
            { day: 21, title: 'Гигиена подушек', task: 'Поменяйте наволочку и проветрите одеяло. Чистота повышает качество отдыха.', benefit: 'Чистая, свежая среда улучшает ощущение комфорта и расслабления.' },
            { day: 22, title: 'Физическая нагрузка', task: 'Убедитесь, что сегодня у вас была умеренная физическая нагрузка (30-45 минут).', benefit: 'Физическая активность повышает "давление сна" и гарантирует более глубокий сон.' },
            { day: 23, title: 'Восстановление режима', task: 'Если вы сбились с режима, сегодня вернитесь к нему строго.', benefit: 'Контроль — это ключ. Однократное нарушение не должно перечеркивать прогресс.' },
            { day: 24, title: 'Двойной контроль темноты', task: 'Проверьте, что в спальне нет ни одного светящегося диода (даже от зарядки).', benefit: 'Микропробуждения от света нарушают структуру сна.' },
            { day: 25, title: 'Растяжка перед сном', task: 'Выполните 10 минут очень медленной и легкой растяжки, фокусируясь на дыхании.', benefit: 'Снимает мышечное напряжение, накопившееся за день.' },
            { day: 26, title: 'Чтение перед сном', task: 'Чтение физической книги или использование E-Ink ридера (без подсветки).', benefit: 'Отвлекает от проблем дня и готовит мозг к отдыху без вреда синего света.' },
            { day: 27, title: 'Самоанализ', task: 'Оцените свой прогресс за 27 дней. Что работает лучше всего?', benefit: 'Осознание эффективности привычек укрепляет внутреннюю мотивацию.' },
            { day: 28, title: 'Новый образ жизни', task: 'Соблюдите все правила: режим, темнота, ритуал, отсутствие кофеина и экранов.', benefit: 'Вы сформировали новую, здоровую привычку! Наслаждайтесь жизнью, полной энергии.' },
        ];


        const TASKS_DATA = { 
            health: [
                { id: 'H1', level: 1, text: 'Выпейте 2 литра чистой воды за день (отметьте факт выполнения).' },
                { id: 'H2', level: 1, text: 'Ложитесь спать на 30 минут раньше обычного 3 дня подряд.' },
                { id: 'H3', level: 2, text: 'Замените один прием пищи салатом (из свежих овощей) хотя бы один раз.' },
                { id: 'H4', level: 2, text: 'В течение недели каждый день делайте перерыв на 10 минут ходьбы (для тех, кто работает сидя).' },
                { id: 'H5', level: 3, text: 'Полностью исключите сахар и сахаросодержащие напитки на 48 часов.' },
                { id: 'H6', level: 3, text: 'Освойте 5-минутную дыхательную практику и выполните ее утром и вечером.' },
                { id: 'H7', level: 4, text: 'Ведите дневник питания 7 дней, не внося изменений, чтобы оценить текущий рацион.' },
                { id: 'H8', level: 4, text: 'Сделайте один день в неделю «цифровым детоксом» (без социальных сетей/развлекательных медиа).' },
                { id: 'H9', level: 5, text: 'Приготовьте 3 новых, здоровых блюда из разных категорий (например, суп, рыба, запеканка).' },
                { id: 'H10', level: 5, text: 'Проведите 15 минут на свежем воздухе сразу после пробуждения.' },
                { id: 'H11', level: 6, text: 'Сделайте полный чек-ап своего здоровья (при условии, что это безопасно и доступно).' },
                { id: 'H12', level: 6, text: 'Практикуйте «интуитивное питание» один день: ешьте, только когда голодны, и останавливайтесь, когда сыты.' },
                { id: 'H13', level: 7, text: 'Разработайте и строго следуйте своему идеальному режиму дня (сон, работа, отдых) в течение двух недель.' },
                { id: 'H14', level: 7, text: 'Изучите свои макронутриенты (белки, жиры, углеводы) и скорректируйте их для достижения цели.' },
                { id: 'H15', level: 7, text: 'Попробуйте 12-часовое интервальное голодание (например, не есть с 20:00 до 8:00).' },
            ],
            sport: [
                { id: 'S1', level: 1, text: 'Выполните 10 отжиманий ИЛИ 15 приседаний за один подход.' },
                { id: 'S2', level: 1, text: 'Сделайте ежедневную 5-минутную разминку для суставов в течение 3 дней.' },
                { id: 'S3', level: 2, text: 'Прогуляйтесь 30 минут в быстром темпе.' },
                { id: 'S4', level: 2, text: 'Освойте правильную технику планки (держать 30 секунд).' },
                { id: 'S5', level: 3, text: 'Пробегите 1 километр без остановки.' },
                { id: 'S6', level: 3, text: 'Найдите 3 разных упражнения для спины и выполните их по 10 повторений.' },
                { id: 'S7', level: 4, text: 'Выполните тренировку HIIT (высокоинтенсивную интервальную тренировку) продолжительностью 20 минут.' },
                { id: 'S8', level: 4, text: 'Увеличьте количество приседаний до 50 за день (можно в несколько подходов).' },
                { id: 'S9', level: 5, text: 'Пробегите 3 километра. Замерьте время и запишите его.' },
                { id: 'S10', level: 5, text: 'Запишитесь на пробное занятие по новому виду спорта (например, йога, скалолазание, единоборства).' },
                { id: 'S11', level: 6, text: 'Тренируйтесь 5 дней подряд, делая акцент на разные группы мышц.' },
                { id: 'S12', level: 6, text: 'Изучите основы питания до и после тренировки.' },
                { id: 'S13', level: 7, text: 'Составьте полноценный 4-недельный тренировочный план и начните следовать ему.' },
                { id: 'S14', level: 7, text: 'Пробегите 5 километров без остановок. Это ваша цель!' },
                { id: 'S15', level: 7, text: 'Научитесь делать 10 чистых подтягиваний (или 5, если вы девушка).' },
            ],
            communication: [
                { id: 'C16', level: 1, text: 'Поздоровайтесь и улыбнитесь трем незнакомым людям (например, кассиру, соседу).' },
                { id: 'C17', level: 1, text: 'Похвалите кого-то искренне за что-то конкретное (внешность, работу).' },
                { id: 'C18', level: 2, text: 'Начните короткий, не обязывающий разговор (например, о погоде) с новым человеком.' },
                { id: 'C19', level: 2, text: 'Активно слушайте своего собеседника, не перебивая, в течение 10 минут.' },
                { id: 'C20', level: 3, text: 'Спросите у кого-то совета или рекомендации по поводу фильма/книги/места.' },
                { id: 'C21', level: 3, text: 'Напишите сообщение тому, с кем давно не общались, и спросите, как дела.' },
                { id: 'C22', level: 4, text: 'Познакомьтесь с новым человеком и поговорите с ним не менее 5 минут.' },
                { id: 'C23', level: 4, text: 'Задайте 5 открытых вопросов во время разговора (начинаются со слов "Как", "Почему", "Что").' },
                { id: 'C24', level: 5, text: 'Защитите свое мнение в споре или дискуссии, используя 3 аргумента.' },
                { id: 'C25', level: 5, text: 'Сделайте комплимент, используя 3 разных слова, описывающих одно качество.' },
                { id: 'C26', level: 6, text: 'Попросите о чем-то, что вызывает у вас дискомфорт (например, о скидке, о помощи).' },
                { id: 'C27', level: 6, text: 'Проведите 30-минутный разговор, не используя слова-паразиты.' },
                { id: 'C28', level: 7, text: 'Выступите с 5-минутной импровизированной речью на случайную тему перед аудиторией (даже небольшой).' },
                { id: 'C29', level: 7, text: 'Помогите двум людям познакомиться друг с другом, выступив посредником.' },
                { id: 'C30', level: 7, text: 'Организуйте небольшую встречу/мероприятие для группы людей.' },
            ],
            learning: [
                { id: 'L16', level: 1, text: 'Прочитайте 10 страниц книги по теме, в которой вы хотите развиваться.' },
                { id: 'L17', level: 1, text: 'Посмотрите 10-минутное образовательное видео и запишите 3 ключевых вывода.' },
                { id: 'L18', level: 2, text: 'Посвятите 30 минут изучению нового навыка (например, языка, инструмента, кода).' },
                { id: 'L19', level: 2, text: 'Изучите один новый термин или концепцию, связанную с вашей сферой деятельности.' },
                { id: 'L20', level: 3, text: 'Напишите короткий обзор (200 слов) о том, что вы недавно узнали.' },
                { id: 'L21', level: 3, text: 'Составьте список из 5 книг/курсов, которые помогут вам достичь долгосрочной цели.' },
                { id: 'L22', level: 4, text: 'Объясните новую сложную концепцию другому человеку простыми словами.' },
                { id: 'L23', level: 4, text: 'Создайте "карту знаний" (mind map) по новой теме.' },
                { id: 'L24', level: 5, text: 'Выделите 2 часа на глубокое изучение одного подраздела (без отвлечений).' },
                { id: 'L25', level: 5, text: 'Начните вести журнал обучения, чтобы отслеживать свой прогресс и трудности.' },
                { id: 'L26', level: 6, text: 'Примените на практике новый навык или знание, которое вы изучали (сделайте что-то реальное).' },
                { id: 'L27', level: 6, text: 'Пройдите полный модуль онлайн-курса и выполните все практические задания.' },
                { id: 'L28', level: 7, text: 'Завершите онлайн-курс/сертификацию, связанную с вашей карьерой.' },
                { id: 'L29', level: 7, text: 'Разработайте план обучения на ближайшие 6 месяцев с конкретными, измеримыми целями.' },
                { id: 'L30', level: 7, text: 'Напишите небольшую статью/эссе (1000 слов), обобщающую знания по новой теме.' },
            ],
        };


        const LIBRARY_DATA = { 
            'Книга 1': { title: 'Искусство Мыслить Ясно', author: 'Рольф Добелли', content: `
                <h4 class="text-xl font-semibold mb-3">О книге:</h4>
                <p class="mb-4">Эта книга — навигатор по ловушкам мышления, которые ежедневно ставят нам палки в колеса. Добелли, опираясь на психологию и экономику, собрал 52 когнитивных искажения, которые мешают принимать рациональные решения. Цель книги — научить читателя узнавать эти ошибки в своих рассуждениях и, главное, избегать их. В отличие от тяжеловесных академических трудов, книга написана в легкой, афористичной манере, где каждое искажение описано на двух страницах и снабжено примером из жизни.</p>
                <h4 class="text-xl font-semibold mb-3">Ключевые идеи и цитаты (фрагмент):</h4>
                <p class="library-content">
                    **Ошибка выжившего:** Мы систематически переоцениваем шансы на успех, потому что на виду остаются только "выжившие" — успешные люди, компании или проекты. Мы не видим огромного кладбища провалившихся идей, поэтому склонны к необоснованному оптимизму. Это искажение особенно опасно в стартапах и инвестициях. Мы смотрим на Билла Гейтса и Марка Цукерберга, но игнорируем миллионы людей, которые пытались, но не смогли. Урок: анализируйте не только успех, но и неудачу.
                    <br><br>
                    **Иллюзия тела пловца:** Занимаемся ли мы плаванием, потому что у нас идеальное тело, или у нас идеальное тело, потому что мы занимаемся плаванием? Важно различать причину и следствие. Реклама часто показывает нам счастливых людей с определенными продуктами, создавая иллюзию, что продукт — причина счастья. На самом деле, часто это просто корреляция или полностью обратная связь. Спросите себя: что является первопричиной успеха?
                    <br><br>
                    **Склонность к подтверждению:** Мы ищем информацию, которая подтверждает наши существующие убеждения, и игнорируем или недооцениваем ту, что им противоречит. Это фильтр, через который мы воспринимаем мир. Если вы верите в эффективность диеты, вы будете искать истории успеха, а не научные опровержения. Чтобы развиваться, нужно активно искать опровергающие данные — это болезненно, но необходимо для объективности. Как сказал один философ, "самое большое препятствие для открытия — это не невежество, а иллюзия знания."
                    <br><br>
                    **Эффект контраста:** Мы оцениваем вещи не по абсолютной шкале, а по сравнению с тем, что находится рядом. Небольшая скидка кажется огромной, если она следует за очень дорогим товаром. Это часто используется в продажах и переговорах. Чтобы избежать этой ловушки, всегда используйте абсолютные метрики и игнорируйте контекст, созданный для манипуляции.
                    <br><br>
                    **Проблема с нулевым риском:** Мы склонны тратить много ресурсов на полное устранение минимального риска, в то время как эти ресурсы могли бы быть потрачены на значительное сокращение более крупного риска. Люди предпочитают нулевой риск, даже если это иррационально с точки зрения общей безопасности. Научитесь принимать небольшие остаточные риски, чтобы максимизировать общую выгоду и безопасность.
                </p>
            `, quotes: ['Анализируйте не только успех, но и неудачу.'] },
            'Книга 2': { title: 'Поток: Психология оптимального переживания', author: 'Михай Чиксентмихайи', content: `
                <h4 class="text-xl font-semibold mb-3">О книге:</h4>
                <p class="mb-4">Чиксентмихайи вводит концепцию "Потока" (Flow) — состояния полного погружения и наслаждения деятельностью, когда время пролетает незаметно, и мы чувствуем себя максимально реализованными. Это не пассивное удовольствие, а активное, требующее усилий, но приносящее глубокое удовлетворение. Книга исследует, как структурировать свою жизнь, чтобы чаще попадать в это оптимальное состояние и повышать качество жизни.</p>
                <h4 class="text-xl font-semibold mb-3">Ключевые идеи и цитаты (фрагмент):</h4>
                <p class="library-content">
                    **Условия Потока:** Состояние Потока возникает, когда уровень ваших навыков точно соответствует уровню сложности задачи. Если задача слишком проста, наступает скука; если слишком сложна — тревога. Идеальный баланс позволяет полностью сконцентрироваться на процессе. Ключевые условия: четкие цели, немедленная обратная связь и ощущение контроля над действиями.
                    <br><br>
                    **Автотелический опыт:** Это опыт, который ценен сам по себе, а не из-за внешней награды. Когда вы находитесь в Потоке, вы делаете это не ради денег, похвалы или достижения цели, а ради самого процесса. Жизнь, наполненная автотелическими переживаниями, — это жизнь, которую вы любите. Целью развития должно стать превращение большего количества рутинных действий в автотелические.
                    <br><br>
                    **Внутренний хаос и психическая энтропия:** Когда наше внимание направлено наружу на беспорядочные или пугающие внешние стимулы, наше сознание приходит в беспорядок, который Чиксентмихайи называет психической энтропией. Поток — это способ организации сознания, способ концентрации внимания на задачах, которые мы выбрали сами, что позволяет нам управлять внутренним опытом и устранять беспокойство.
                    <br><br>
                    **Расширение границ:** Чтобы продолжать испытывать Поток, мы должны постоянно повышать сложность своих задач по мере роста наших навыков. Это спираль развития: вы осваиваете навык, вам становится скучно, вы повышаете сложность, и снова входите в Поток на новом, более высоком уровне. Жизнь без этого расширения — это стагнация.
                    <br><br>
                    **Ключевая цитата:** «Самые лучшие моменты в нашей жизни — это не пассивные, принимающие, расслабляющие моменты... Самые лучшие моменты обычно происходят, когда тело или разум человека напряжены до предела в добровольном усилии достичь чего-то трудного и стоящего.»
                </p>
            `, quotes: ['Самые лучшие моменты происходят, когда тело или разум напряжены до предела в добровольном усилии.'] },
            'Книга 3': { title: 'Атомные привычки', author: 'Джеймс Клир', content: `
                <h4 class="text-xl font-semibold mb-3">О книге:</h4>
                <p class="mb-4">Джеймс Клир утверждает: чтобы добиться невероятных результатов, не нужно совершать революционные изменения. Достаточно ежедневно улучшать свои действия всего на 1%. Сосредоточьтесь на системе, а не на цели. Если вы будете становиться лучше на 1% каждый день, то через год вы будете лучше в 37 раз. Книга представляет простую, но мощную систему из четырех законов изменения поведения: Сделай очевидным, Сделай привлекательным, Сделай легким, Сделай приятным.</p>
                <h4 class="text-xl font-semibold mb-3">Ключевые идеи и цитаты (фрагмент):</h4>
                <p class="library-content">
                    **Сила 1%:** Привычки — это сложные проценты самосовершенствования. Изменения кажутся незначительными на ежедневной основе, но их влияние на месяцы и годы ошеломляет. Мы переоцениваем одно определяющее событие и недооцениваем ценность маленьких ежедневных улучшений. Настоящий прогресс — это не одно большое достижение, а результат сотен маленьких действий.
                    <br><br>
                    **Фокус на Системе, а не Целях:** Цели — это результаты, которые вы хотите получить. Системы — это процессы, которые к этим результатам приводят. Если вы будете игнорировать свою систему и просто преследовать цель, вы будете постоянно возвращаться к своим старым привычкам после достижения цели. Секрет заключается в том, чтобы полюбить рутину, которая приведет к успеху.
                    <br><br>
                    **Идентичность:** Наиболее глубокое изменение поведения происходит, когда мы начинаем менять не то, что мы делаем, а то, **кем мы являемся**. Вместо "Я хочу пробежать марафон" (цель) или "Я буду бегать каждое утро" (процесс), думайте: "Я бегун" (идентичность). Ваше поведение должно подтверждать вашу новую идентичность.
                    <br><br>
                    **Четыре закона:**
                    <ol class="list-decimal list-inside ml-4 space-y-2 mt-2">
                        <li>**Сделай очевидным (Ключ к подсказке):** Четко определите, когда и где вы будете выполнять привычку. Используйте "Намерение реализации" (Я буду [поведение] в [время] в [место]).</li>
                        <li>**Сделай привлекательным (Ключ к тяге):** Используйте "Связывание искушений" (Сначала я сделаю [то, что нужно], потом [то, что я хочу]).</li>
                        <li>**Сделай легким (Ключ к ответу):** Снижайте трение. Сделайте так, чтобы для выполнения привычки требовалось всего две минуты или меньше. Это "Правило двух минут".</li>
                        <li>**Сделай приятным (Ключ к награде):** Используйте немедленное подкрепление. Чем быстрее и приятнее награда, тем быстрее мозг свяжет действие с хорошим чувством.</li>
                    </ol>
                </p>
                <h4 class="text-xl font-semibold mt-4 mb-3">Цитата:</h4>
                <p class="library-content italic text-gray-600">«Вы не поднимаетесь до уровня своих целей. Вы падаете до уровня своих систем.»</p>
            `, quotes: ['Вы не поднимаетесь до уровня своих целей. Вы падаете до уровня своих систем.'] },
        };


        // --- FIREBASE AND AUTH INITIALIZATION ---

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing. Running in local mode without persistence.");
                isAuthReady = true;
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Use the provided custom token for authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    // Fallback to anonymous sign-in if no token is provided
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').innerHTML = `<i class="fas fa-user-circle mr-1"></i> ID: ${userId.substring(0, 8)}...`;
                        loadUserData(); // Start listening for data changes
                    } else {
                        console.log("User signed out or failed to authenticate.");
                        isAuthReady = true;
                        userId = null;
                        document.getElementById('user-id-display').innerHTML = `<i class="fas fa-user-circle mr-1"></i> ID: Аноним`;
                        renderContent(window.appState.activeTab);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showModal("Ошибка инициализации", "Не удалось подключиться к базе данных. Попробуйте перезагрузить приложение.");
                isAuthReady = true;
            }
        }

        // Firestore Data Management Functions
        const getUserDocRef = () => doc(db, 'artifacts', appId, 'users', userId, 'data', 'progress');

        function loadUserData() {
            if (!db || !userId) return;
            // Listen for real-time updates to the user's progress
            onSnapshot(getUserDocRef(), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    // Update state with saved data, ensuring chat history is loaded
                    const data = docSnapshot.data();
                    window.appState.userData = {
                        ...window.appState.userData,
                        ...data,
                        chatHistory: data.chatHistory || [], // Ensure chatHistory is an array
                        selectedTrainer: data.selectedTrainer || TRAINERS.aurora.key
                    };
                } else {
                    // Document does not exist, initialize data
                    saveUserData(); 
                }
                renderContent(window.appState.activeTab);
                hideLoading();
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                hideLoading();
            });
        }

        async function saveUserData() {
            if (!db || !userId) {
                console.warn("Cannot save: Firebase or User ID not ready.");
                return;
            }
            try {
                // Only save the userData object
                await setDoc(getUserDocRef(), window.appState.userData, { merge: true });
                // console.log("Progress saved successfully.");
            } catch (e) {
                console.error("Error saving document: ", e);
                showModal("Ошибка сохранения", "Не удалось сохранить ваш прогресс в облаке. Пожалуйста, проверьте ваше соединение.");
            }
        }

        // --- LOADING STATE UTILITIES ---
        function showLoading() {
            document.getElementById('loading-spinner').classList.remove('hidden');
            document.getElementById('loading-spinner').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('loading-spinner').classList.remove('flex');
        }

        // --- AI (GEMINI) CORE LOGIC ---

        /**
         * Sends a message to the Gemini API with a specific system instruction (personality).
         * @param {string} userMessage - The message from the user.
         * @param {string} trainerKey - The key of the selected trainer ('aurora', 'johnny', 'silas').
         * @returns {Promise<string>} - The AI's response text.
         */
        async function sendMessageToAI(userMessage, trainerKey) {
            const trainer = Object.values(TRAINERS).find(t => t.key === trainerKey);
            if (!trainer) {
                return "Извините, я не нашел этого тренера.";
            }

            const apiKey = "AIzaSyD0Sv6u0aFGjJBFp9CN5qoXu_NinYEnt1I"; // API key will be injected by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const maxRetries = 5;

            // Constructing chat history for context (optional but recommended)
            // Use only the last 10 messages for brevity
            const contents = window.appState.userData.chatHistory
                .slice(-10) 
                .map(msg => ({ 
                    role: msg.role === 'user' ? 'user' : 'model', 
                    parts: [{ text: msg.text }] 
                }))
                .concat([{ role: 'user', parts: [{ text: userMessage }] }]);

            const payload = {
                contents: contents,
                systemInstruction: {
                    parts: [{ text: trainer.systemInstruction }] // Injecting the personality here!
                },
            };

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && attempt < maxRetries - 1) {
                            // Exponential Backoff: Wait and retry
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    
                    return text || "Тренер не смог сформулировать ответ.";

                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error);
                    if (attempt === maxRetries - 1) {
                        return `Извините, не удалось связаться с Тренером после ${maxRetries} попыток. (${error.message})`;
                    }
                    // Wait for backoff if not the last attempt
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        // --- UI RENDER FUNCTIONS ---

        function setTab(tabId) {
            window.appState.activeTab = tabId;
            renderContent(tabId);
            // Highlight active tab
            document.querySelectorAll('.tab-button').forEach(btn => {
                if (btn.id === `tab-${tabId}`) {
                    btn.classList.add('active');
                    btn.classList.remove('text-gray-500');
                } else {
                    btn.classList.remove('active');
                    btn.classList.add('text-gray-500');
                }
            });
        }

        function renderNavigation() {
            const nav = document.getElementById('app-navigation');
            nav.innerHTML = TABS.map(tab => `
                <button id="tab-${tab.id}" 
                        onclick="setTab('${tab.id}')"
                        class="tab-button inline-flex items-center px-4 py-2 text-sm font-medium text-gray-500 hover:text-indigo-600 focus:outline-none">
                    <i class="${tab.icon} mr-2"></i>
                    ${tab.name}
                </button>
            `).join('');
            setTab(window.appState.activeTab); // Set initial active tab
        }
        
        function renderContent(tabId) {
            const contentArea = document.getElementById('content-area');
            contentArea.scrollTop = 0; // Scroll to top on tab change

            if (!isAuthReady) {
                contentArea.innerHTML = '<div class="text-center p-10 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i> Загрузка приложения и данных пользователя...</div>';
                return;
            }

            switch (tabId) {
                case 'home': renderHomeTab(contentArea); break;
                case 'tasks': renderTasksTab(contentArea); break;
                case 'challenges': renderChallengesTab(contentArea); break;
                case 'healthy_sleep': renderSleepPlanTab(contentArea); break;
                case 'library': renderLibraryTab(contentArea); break;
                case 'chat': renderChatTab(contentArea); break;
                default: contentArea.innerHTML = '<div class="text-center p-10 text-gray-500">Страница не найдена.</div>';
            }
        }

        function renderHomeTab(contentArea) {
            const randomQuote = MOTIVATIONAL_PHRASES[Math.floor(Math.random() * MOTIVATIONAL_PHRASES.length)];
            
            // Calculate progress metrics
            const totalTasks = Object.values(TASKS_DATA).flat().length;
            const completedTasks = window.appState.userData.tasks.filter(t => t.status === 'completed').length;
            const taskProgressPercent = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            const totalChallenges = CHALLENGES_DATA.length;
            const activeChallenges = window.appState.userData.challenges.filter(c => c.status === 'active').length;
            const completedChallenges = window.appState.userData.challenges.filter(c => c.status === 'completed').length;
            
            // Get current trainer info
            const currentTrainer = TRAINERS[window.appState.userData.selectedTrainer] || TRAINERS.aurora;

            contentArea.innerHTML = `
                <div class="space-y-8">
                    
                    <!-- Welcome & Quote Card -->
                    <div class="p-6 sm:p-8 bg-indigo-50 rounded-2xl shadow-lg border border-indigo-200">
                        <h2 class="text-3xl sm:text-4xl font-extrabold text-indigo-800 mb-2">Добро пожаловать обратно!</h2>
                        <p class="text-indigo-600 text-lg mb-4">Начните с того, что вдохновляет вас больше всего.</p>
                        <blockquote class="italic text-gray-700 p-4 border-l-4 border-indigo-400 bg-white rounded-lg shadow-sm">
                            <i class="fas fa-quote-left text-indigo-300 mr-2"></i>
                            ${randomQuote}
                            <i class="fas fa-quote-right text-indigo-300 ml-2"></i>
                        </blockquote>
                    </div>

                    <!-- Trainer Card -->
                    <div class="p-6 bg-white rounded-2xl shadow-md border border-gray-100 flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full ${currentTrainer.bg} mr-4">
                                <i class="${currentTrainer.icon} text-3xl ${currentTrainer.color}"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Ваш личный Тренер: ${currentTrainer.name}</h3>
                                <p class="text-sm text-gray-500">${currentTrainer.role}</p>
                            </div>
                        </div>
                        <button onclick="setTab('chat')" class="px-4 py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors shadow-md">
                            Написать Тренеру
                        </button>
                    </div>

                    <!-- Progress Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        
                        <!-- Task Progress Card -->
                        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold text-gray-700">Прогресс Задач</h4>
                                <i class="fas fa-tasks text-indigo-500 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-indigo-600">${completedTasks} / ${totalTasks}</p>
                            <p class="text-sm text-gray-500">Выполнено задач</p>
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-3">
                                <div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${taskProgressPercent}%"></div>
                            </div>
                            <p class="text-xs text-indigo-500 mt-1">${taskProgressPercent}% завершено</p>
                        </div>

                        <!-- Challenge Status Card -->
                        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold text-gray-700">Челленджи</h4>
                                <i class="fas fa-running text-violet-500 text-2xl"></i>
                            </div>
                            <p class="text-3xl font-bold text-violet-600">${activeChallenges}</p>
                            <p class="text-sm text-gray-500">Активных челленджей</p>
                            <div class="text-sm text-gray-500 mt-2">
                                <span class="font-semibold text-green-600">${completedChallenges}</span> завершено.
                            </div>
                            <button onclick="setTab('challenges')" class="text-sm mt-3 text-violet-600 hover:underline">
                                Начать новый <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                        
                        <!-- Sleep Plan Card -->
                        <div class="bg-white p-6 rounded-2xl shadow-md border border-gray-100">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="text-lg font-semibold text-gray-700">28 Дней Сна</h4>
                                <i class="fas fa-bed text-blue-500 text-2xl"></i>
                            </div>
                            ${renderSleepPlanProgress()}
                            <button onclick="setTab('healthy_sleep')" class="text-sm mt-3 text-blue-600 hover:underline">
                                Посмотреть план <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    </div>

                </div>
            `;
        }
        
        // Helper function for Home Tab
        function renderSleepPlanProgress() {
            const completedDays = window.appState.userData.sleepPlan.filter(d => d.completed).length;
            if (completedDays === SLEEP_PLAN.length) {
                return `
                    <p class="text-3xl font-bold text-green-600">${completedDays}</p>
                    <p class="text-sm text-gray-500">Дней завершено. Отличная привычка!</p>
                `;
            }
            return `
                <p class="text-3xl font-bold text-blue-600">${completedDays} / ${SLEEP_PLAN.length}</p>
                <p class="text-sm text-gray-500">Дней завершено. Продолжайте!</p>
            `;
        }
        
        function renderTasksTab(contentArea) {
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Ежедневные Задачи</h2>
                <p class="text-gray-600 mb-8">Задачи разбиты по областям развития и уровню сложности. Начните с 1-го уровня.</p>
                <div id="tasks-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    ${Object.entries(TASKS_DATA).map(([sphereKey, tasks]) => `
                        <div class="bg-white p-5 rounded-xl shadow-lg border-t-4 border-indigo-400">
                            <h3 class="text-xl font-bold text-indigo-700 mb-4">${SPHERES[sphereKey]}</h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto custom-scrollbar">
                                ${tasks.map(task => {
                                    const userTask = window.appState.userData.tasks.find(t => t.id === task.id);
                                    const status = userTask ? userTask.status : 'pending';
                                    const isCompleted = status === 'completed';
                                    const isGivenUp = status === 'given_up';
                                    
                                    let statusClasses = '';
                                    let icon = '';
                                    if (isCompleted) {
                                        statusClasses = 'bg-green-100 border-green-400';
                                        icon = '<i class="fas fa-check-circle text-green-600 mr-2"></i>';
                                    } else if (isGivenUp) {
                                        statusClasses = 'bg-red-100 border-red-400';
                                        icon = '<i class="fas fa-times-circle text-red-600 mr-2"></i>';
                                    } else {
                                        statusClasses = 'bg-white border-gray-300 hover:shadow-md';
                                        icon = '<i class="fas fa-circle text-gray-400 mr-2"></i>';
                                    }

                                    return `
                                        <div class="task-card p-3 border rounded-lg ${statusClasses}">
                                            <p class="text-sm font-semibold text-gray-800 flex items-start mb-2">
                                                ${icon} ${task.text}
                                            </p>
                                            <div class="flex justify-between items-center text-xs text-gray-500">
                                                <span>Уровень: ${task.level}</span>
                                                <div class="flex space-x-2">
                                                    ${!isCompleted ? `<button onclick="completeTask('${task.id}')" class="text-green-600 hover:text-green-800 font-medium disabled:opacity-50" ${isGivenUp ? 'disabled' : ''}>
                                                        Выполнить
                                                    </button>` : `<span class="text-green-600 font-medium">Готово!</span>`}
                                                    
                                                    ${!isGivenUp && !isCompleted ? `<button onclick="showGiveUpModal('${task.id}')" class="text-red-600 hover:text-red-800 font-medium">
                                                        Сдаться
                                                    </button>` : ''}
                                                </div>
                                            </div>
                                            ${isGivenUp && userTask.explanation ? `<p class="mt-2 text-xs text-red-700 italic border-t pt-1">Причина: ${userTask.explanation}</p>` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            // Add event listener for the give-up form
            document.getElementById('give-up-form').onsubmit = (e) => {
                e.preventDefault();
                handleGiveUpSubmit();
            };
        }
        
        function completeTask(taskId) {
            const tasks = window.appState.userData.tasks;
            const existingTaskIndex = tasks.findIndex(t => t.id === taskId);
            
            if (existingTaskIndex !== -1) {
                // Task exists, update status
                tasks[existingTaskIndex].status = 'completed';
                tasks[existingTaskIndex].completedAt = new Date().toISOString();
            } else {
                // New task completed
                tasks.push({
                    id: taskId,
                    status: 'completed',
                    completedAt: new Date().toISOString()
                });
            }
            saveUserData();
            renderContent('tasks');
            showModal("Отлично!", "Задача отмечена как выполненная. Гордитесь своим прогрессом!");
        }

        function showGiveUpModal(taskId) {
            window.appState.currentGiveUpTask = taskId;
            document.getElementById('give-up-explanation').value = ''; // Clear previous text
            document.getElementById('give-up-modal').classList.remove('hidden');
            document.getElementById('give-up-modal').classList.add('flex');
        }

        function handleGiveUpSubmit() {
            const taskId = window.appState.currentGiveUpTask;
            const explanation = document.getElementById('give-up-explanation').value.trim();

            if (!taskId) return;
            
            const tasks = window.appState.userData.tasks;
            const existingTaskIndex = tasks.findIndex(t => t.id === taskId);

            if (existingTaskIndex !== -1) {
                tasks[existingTaskIndex].status = 'given_up';
                tasks[existingTaskIndex].givenUpAt = new Date().toISOString();
                tasks[existingTaskIndex].explanation = explanation;
            } else {
                tasks.push({
                    id: taskId,
                    status: 'given_up',
                    givenUpAt: new Date().toISOString(),
                    explanation: explanation
                });
            }

            window.appState.currentGiveUpTask = null;
            document.getElementById('give-up-modal').classList.add('hidden');
            saveUserData();
            renderContent('tasks');
            showModal("Понятно", `Задача отмечена как "сданная". Тренер ${TRAINERS[window.appState.userData.selectedTrainer].name} проанализирует вашу причину (${explanation.substring(0, 30)}...) и поможет найти решение в чате!`);
        }

        function renderChallengesTab(contentArea) {
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Челленджи (Вызовы)</h2>
                <p class="text-gray-600 mb-8">Выберите челлендж, который поможет вам сформировать новую устойчивую привычку. Сфокусируйтесь на одном вызове за раз!</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    ${CHALLENGES_DATA.map(challenge => {
                        const userChallenge = window.appState.userData.challenges.find(c => c.id === challenge.id);
                        const status = userChallenge ? userChallenge.status : 'available';
                        
                        let cardClasses = 'bg-white p-6 rounded-2xl shadow-lg border ';
                        let statusText = 'Доступен';
                        let buttonHtml = `<button onclick="startChallenge('${challenge.id}')" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors">Начать Челлендж</button>`;

                        if (status === 'active') {
                            cardClasses += 'border-yellow-500 ring-4 ring-yellow-100';
                            statusText = `<span class="text-yellow-600 font-bold"><i class="fas fa-hourglass-half mr-1"></i> Активен</span>`;
                            buttonHtml = `<button onclick="completeChallenge('${challenge.id}')" class="w-full py-2 bg-green-600 text-white font-semibold rounded-xl hover:bg-green-700 transition-colors">Я завершил(а)!</button>`;
                        } else if (status === 'completed') {
                            cardClasses += 'border-green-500 opacity-70';
                            statusText = `<span class="text-green-600 font-bold"><i class="fas fa-trophy mr-1"></i> Завершен</span>`;
                            buttonHtml = `<button disabled class="w-full py-2 bg-gray-400 text-white font-semibold rounded-xl">Завершено (${new Date(userChallenge.completedAt).toLocaleDateString('ru')})</button>`;
                        } else {
                            cardClasses += 'border-gray-200 hover:shadow-xl';
                        }
                        
                        return `
                            <div class="${cardClasses} challenge-card">
                                <div class="flex justify-between items-start mb-4">
                                    <h3 class="text-2xl font-bold text-gray-800">${challenge.name}</h3>
                                    ${statusText}
                                </div>
                                <div class="flex justify-between text-sm text-gray-500 mb-4 border-b pb-3">
                                    <span><i class="fas fa-clock mr-1"></i> Длительность: ${challenge.duration} дней</span>
                                    <span><i class="fas fa-lightbulb mr-1"></i> Фокус: ${challenge.focus}</span>
                                </div>
                                <p class="font-semibold text-gray-700 mb-3">Ключевые шаги:</p>
                                <ul class="list-disc list-inside text-gray-600 space-y-2 mb-6 ml-2">
                                    ${challenge.steps.map(step => `<li>${step}</li>`).join('')}
                                </ul>
                                ${buttonHtml}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function startChallenge(challengeId) {
            // Check if another challenge is already active
            const activeChallenge = window.appState.userData.challenges.find(c => c.status === 'active');
            if (activeChallenge) {
                showModal("Подождите", "У вас уже активен один челлендж. Сфокусируйтесь на нем или завершите его, прежде чем начать новый.");
                return;
            }

            const challenge = CHALLENGES_DATA.find(c => c.id === challengeId);
            if (!challenge) return;

            // Mark as active
            window.appState.userData.challenges.push({
                id: challengeId,
                status: 'active',
                startedAt: new Date().toISOString()
            });

            saveUserData();
            renderContent('challenges');
            showModal("Успех!", `Вы начали челлендж **"${challenge.name}"**! Помните о дисциплине. Удачи!`);
        }

        function completeChallenge(challengeId) {
            const challengeIndex = window.appState.userData.challenges.findIndex(c => c.id === challengeId && c.status === 'active');
            if (challengeIndex === -1) return;

            window.appState.userData.challenges[challengeIndex].status = 'completed';
            window.appState.userData.challenges[challengeIndex].completedAt = new Date().toISOString();

            saveUserData();
            renderContent('challenges');
            showModal("ПОБЕДА!", `Поздравляем! Вы успешно завершили челлендж **"${CHALLENGES_DATA.find(c => c.id === challengeId).name}"**! Не забудьте закрепить привычку.`);
        }
        
        function renderSleepPlanTab(contentArea) {
            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">План "Здоровый Сон" (28 Дней)</h2>
                <p class="text-gray-600 mb-8">Следуйте этому 28-дневному плану, чтобы радикально улучшить качество своего сна и уровень энергии. Выполняйте по одному заданию в день.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    ${SLEEP_PLAN.map(day => {
                        const userDay = window.appState.userData.sleepPlan.find(d => d.day === day.day);
                        const isCompleted = userDay && userDay.completed;
                        
                        let cardClasses = 'bg-white p-5 rounded-xl shadow-lg border ';
                        let iconHtml = '';
                        let buttonHtml = '';

                        if (isCompleted) {
                            cardClasses += 'border-green-400 bg-green-50';
                            iconHtml = `<i class="fas fa-check-circle text-green-600 text-3xl mr-3"></i>`;
                            buttonHtml = `<button disabled class="w-full py-2 bg-green-600 text-white font-semibold rounded-xl opacity-70">Завершено</button>`;
                        } else {
                            cardClasses += 'border-gray-200 hover:shadow-xl';
                            iconHtml = `<i class="fas fa-bed text-indigo-600 text-3xl mr-3"></i>`;
                            buttonHtml = `<button onclick="completeSleepDay(${day.day})" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition-colors">Отметить как выполненное</button>`;
                        }

                        return `
                            <div class="${cardClasses}">
                                <div class="flex items-center mb-4">
                                    ${iconHtml}
                                    <div>
                                        <h3 class="text-xl font-bold text-gray-800">День ${day.day}: ${day.title}</h3>
                                        <p class="text-sm text-gray-500">${isCompleted ? 'Выполнено' : 'Предстоит'}</p>
                                    </div>
                                </div>
                                <p class="font-semibold text-gray-700 mb-2">${day.task}</p>
                                <p class="text-sm text-indigo-500 border-t pt-2 mt-2">
                                    **Почему это важно:** ${day.benefit}
                                </p>
                                <div class="mt-4">
                                    ${buttonHtml}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function completeSleepDay(dayNumber) {
            const plan = window.appState.userData.sleepPlan;
            const existingDayIndex = plan.findIndex(d => d.day === dayNumber);
            
            if (existingDayIndex !== -1) {
                plan[existingDayIndex].completed = true;
            } else {
                plan.push({ day: dayNumber, completed: true });
            }

            saveUserData();
            renderContent('healthy_sleep');
            showModal("Прогресс!", `День ${dayNumber} отмечен! Вы на шаг ближе к идеальному сну.`);
        }

        let activeBook = null; // State for tracking the currently viewed book

        function renderLibraryTab(contentArea) {
            if (activeBook) {
                renderBookDetail(contentArea, activeBook);
                return;
            }

            contentArea.innerHTML = `
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Библиотека Знаний</h2>
                <p class="text-gray-600 mb-8">Краткие обзоры и ключевые идеи из лучших книг по саморазвитию, мышлению и продуктивности.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    ${Object.entries(LIBRARY_DATA).map(([key, book]) => `
                        <div class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 hover:shadow-xl transition-shadow cursor-pointer" onclick="setActiveBook('${key}')">
                            <i class="fas fa-book-open text-indigo-500 text-3xl mb-3"></i>
                            <h3 class="text-xl font-bold text-gray-800 mb-1">${book.title}</h3>
                            <p class="text-sm text-gray-500 italic mb-4">Автор: ${book.author}</p>
                            <p class="text-sm text-gray-600 line-clamp-3">${book.content.replace(/<[^>]*>/g, '').substring(0, 150)}...</p>
                            <button class="mt-4 text-indigo-600 hover:underline font-semibold">
                                Читать обзор <i class="fas fa-arrow-right ml-1"></i>
                            </button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function setActiveBook(bookKey) {
            activeBook = bookKey;
            renderContent('library');
        }
        
        function clearActiveBook() {
            activeBook = null;
            renderContent('library');
        }

        function renderBookDetail(contentArea, bookKey) {
            const book = LIBRARY_DATA[bookKey];
            if (!book) {
                clearActiveBook();
                return;
            }
            
            contentArea.innerHTML = `
                <button onclick="clearActiveBook()" class="mb-6 inline-flex items-center text-indigo-600 hover:text-indigo-800 font-semibold">
                    <i class="fas fa-arrow-left mr-2"></i> Вернуться к обзорам
                </button>
                
                <div class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl">
                    <h2 class="text-3xl font-extrabold text-indigo-700 mb-2">${book.title}</h2>
                    <p class="text-lg text-gray-500 italic mb-6">Автор: ${book.author}</p>
                    
                    <div class="prose max-w-none library-content text-gray-700 border p-4 rounded-xl bg-gray-50">
                        ${book.content}
                    </div>

                    ${book.quotes.length > 0 ? `
                        <blockquote class="mt-8 p-4 border-l-4 border-violet-400 bg-violet-50 italic text-violet-700 rounded-lg">
                            <p class="font-medium">«${book.quotes[0]}»</p>
                        </blockquote>
                    ` : ''}
                </div>
            `;
        }

        function renderChatTab(contentArea) {
            const trainerKey = window.appState.userData.selectedTrainer;
            const selectedTrainer = TRAINERS[trainerKey] || TRAINERS.aurora;
            
            // Scroll chat to bottom after render
            setTimeout(() => {
                const chatHistoryDiv = document.getElementById('chat-history');
                if (chatHistoryDiv) {
                    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                }
            }, 50);

            contentArea.innerHTML = `
                <div class="flex flex-col h-full">
                    
                    <!-- Trainer Selector and Info -->
                    <div class="p-4 bg-white rounded-xl shadow-md border border-gray-100 flex flex-col sm:flex-row justify-between items-center mb-6 sticky top-0 z-10">
                        <div class="flex items-center mb-3 sm:mb-0">
                            <div class="p-3 rounded-full ${selectedTrainer.bg} mr-4">
                                <i class="${selectedTrainer.icon} text-3xl ${selectedTrainer.color}"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Общение с Тренером: ${selectedTrainer.name}</h3>
                                <p class="text-sm text-gray-500">${selectedTrainer.role}</p>
                            </div>
                        </div>

                        <div class="w-full sm:w-auto">
                            <label for="trainer-select" class="sr-only">Выбрать тренера</label>
                            <select id="trainer-select" 
                                onchange="changeTrainer(this.value)"
                                class="w-full sm:w-auto p-2 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition-colors bg-white">
                                ${Object.values(TRAINERS).map(t => `
                                    <option value="${t.key}" ${t.key === trainerKey ? 'selected' : ''}>
                                        ${t.name} (${t.role})
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Chat History Area -->
                    <div id="chat-history" class="flex-grow overflow-y-auto p-4 space-y-4 bg-gray-50 rounded-xl mb-4 custom-scrollbar min-h-[300px]">
                        ${window.appState.userData.chatHistory.length === 0 ? 
                            `<div class="text-center text-gray-400 p-10">
                                <i class="fas fa-comments text-4xl mb-3"></i>
                                <p>Начните беседу! Задайте вопрос о своих задачах, привычках или мотивации.</p>
                            </div>` : 
                            window.appState.userData.chatHistory.map(msg => `
                                <div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}">
                                    <div class="message-bubble ${msg.role === 'user' ? 'user-message' : 'ai-message'} shadow">
                                        ${msg.role === 'model' && msg.trainerName ? `<p class="text-xs font-bold mb-1 ${selectedTrainer.color}">${msg.trainerName}:</p>` : ''}
                                        ${msg.text.split('\n').map(p => `<p>${p}</p>`).join('')}
                                    </div>
                                </div>
                            `).join('')
                        }
                        <!-- Typing indicator placeholder -->
                        <div id="typing-indicator" class="hidden flex justify-start">
                            <div class="ai-message shadow animate-pulse">
                                <i class="fas fa-ellipsis-h"></i> Тренер печатает...
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <form id="chat-form" class="flex p-4 bg-white border-t rounded-b-xl">
                        <input type="text" id="chat-input" placeholder="Спросите Тренера о ваших целях или задачах..."
                               class="flex-grow p-3 border border-gray-300 rounded-l-xl focus:ring-indigo-500 focus:border-indigo-500 outline-none" required>
                        <button type="submit" id="send-button"
                                class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-r-xl hover:bg-indigo-700 transition-colors shadow-md flex items-center">
                            <i class="fas fa-paper-plane mr-2"></i> Отправить
                        </button>
                    </form>
                </div>
            `;

            // Setup form submission handler
            document.getElementById('chat-form').onsubmit = handleChatSubmit;
        }

        function changeTrainer(newKey) {
            window.appState.userData.selectedTrainer = newKey;
            saveUserData();
            renderContent('chat');
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const userMessage = input.value.trim();
            const trainerKey = window.appState.userData.selectedTrainer;
            const selectedTrainer = TRAINERS[trainerKey];

            if (!userMessage) return;

            // 1. Add user message to history
            const userMsg = { role: 'user', text: userMessage };
            window.appState.userData.chatHistory.push(userMsg);
            saveUserData();
            input.value = ''; // Clear input field

            // 2. Temporarily render history with typing indicator
            renderChatTab(document.getElementById('content-area'));
            document.getElementById('typing-indicator').classList.remove('hidden');
            const chatHistoryDiv = document.getElementById('chat-history');
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;


            let aiResponseText = "Произошла внутренняя ошибка. Попробуйте еще раз.";

            try {
                // 3. Call the AI function
                aiResponseText = await sendMessageToAI(userMessage, trainerKey);
            } catch (error) {
                console.error("Gemini API call failed:", error);
                aiResponseText = "Ошибка соединения с ИИ. Проверьте интернет или повторите попытку.";
            } finally {
                // 4. Hide typing indicator
                document.getElementById('typing-indicator').classList.add('hidden');

                // 5. Add AI response to history
                const aiMsg = { 
                    role: 'model', 
                    text: aiResponseText, 
                    trainerKey: trainerKey,
                    trainerName: selectedTrainer.name
                };
                window.appState.userData.chatHistory.push(aiMsg);
                
                // 6. Save and re-render the chat tab
                saveUserData();
                renderChatTab(document.getElementById('content-area')); 
            }
        }


        // --- APPLICATION LIFECYCLE ---

        window.onload = function () {
            showLoading();
            if (firebaseConfig) {
                initFirebase();
            } else {
                // If running locally without config, initialize UI anyway
                isAuthReady = true;
                userId = crypto.randomUUID(); // Mock ID for local testing
                document.getElementById('user-id-display').innerHTML = `<i class="fas fa-user-circle mr-1"></i> ID: ${userId.substring(0, 8)}... (Локально)`;
                renderNavigation();
                renderContent(window.appState.activeTab);
                hideLoading();
            }
            renderNavigation(); // Render nav immediately for better feel
            // Expose setTab globally for use in HTML buttons
            window.setTab = setTab;
            window.completeTask = completeTask;
            window.showGiveUpModal = showGiveUpModal;
            window.startChallenge = startChallenge;
            window.completeChallenge = completeChallenge;
            window.completeSleepDay = completeSleepDay;
            window.setActiveBook = setActiveBook;
            window.clearActiveBook = clearActiveBook;
            window.changeTrainer = changeTrainer;
        };

        // Export global functions (required for Canvas environment)
        window.initFirebase = initFirebase;
    </script>
</body>
</html>
